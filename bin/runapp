#!/bin/bash

app=$1
regen="${@: -1}"
args="${@:2}"

# 1>&2 (stderr)
# 1>&3 (console)
# | tee /dev/fd/3 (both console and log)

export LOG_FILE=$SPATIAL_HOME/gen/results.log
export JAVA_OPTS="-Xmx512m"
export _JAVA_OPTIONS="-Xms1024m -Xmx64G -Xss512m"
export SIM_LOG=$SPATIAL_HOME/gen/$app/sim.log

timestemp=$(date +"%c")
#exec 3>&1 1>>${LOG_FILE} 2>&1

echo $app

if [ $regen = true ]; then
	rm -r $SPATIAL_HOME/gen/$app
	mkdir $SPATIAL_HOME/gen/$app
	echo "-------------GEN Spatial------------" >> $SIM_LOG
	$SPATIAL_HOME/bin/spatial $app --retiming --synth &>> $SIM_LOG 
fi

cd $SPATIAL_HOME/gen/$app/

if [ $regen = true ]; then
	echo "-------------MAKE VCS------------" >> $SIM_LOG
	make vcs &>> $SIM_LOG 
fi

chmod u+wrx run.sh
./run.sh $args &>> $SIM_LOG 
cycle=$(grep "Design ran for" $SIM_LOG)
pass=$(grep "PASS" $SIM_LOG)

cd ../../
echo "$timestemp $app $cycle args=[$args] $pass" >> $LOG_FILE 
echo "$timestemp $app $cycle args=[$args] $pass"

#trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT
