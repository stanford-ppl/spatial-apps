#!/bin/bash

source $SPATIAL_HOME/apps/bin/common

function runPass() {
	pass=$1
	reach=0
	for p in ${passes[@]}; do
		if [[ $p == $pass ]]; then reach=1; fi
		if [[ $reach == 0 ]] && [[ ${progress[$p]} != "SUCCESS" ]]; then exit; fi
	done

	passStatus $pass
	if [[ $regen == ALL ]] || [[ $regen == $pass ]] || [[ ${progress[$pass]} != 'SUCCESS' && ${progress[$pass]} != 'RUNNING' ]]; then
		log=${logs[$pass]}
		clean_log $pass

		source ${scripts[$pass]}

		echo $! > $PID_LOG
		wait $!
		sleep 0.1
		echo "-------------$pass(DONE)------------" >> $log
		passStatus $pass
	fi
}

echo "runapp $app torun=$torun regen=$regen"

mkdir -p $SPATIAL_HOME/gen/$app
mkdir -p $PIR_HOME/apps/src/gen/
mkdir -p $PIR_HOME/out/$app

for pass in ${passes[@]}; do
	if [[ $torun == 'ALL' ]] || [[ $torun == *$pass ]] || [[ $torun == $pass* ]] || [[ $torun == $pass ]]; then
	  runPass $pass
  fi
done

pass="RUN_SIMULATION"; log=${logs[$pass]}; 
cycle=$(grep "Design ran for" $log)
passed=$(grep "PASS" $log)
echo "$timestemp $app $cycle args=[$args] $passed" >> $LOG_FILE 
echo "$timestemp $app $cycle args=[$args] $passed"
