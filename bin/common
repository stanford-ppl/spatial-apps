#!/bin/bash

app=$1
args="${@:2}"
torun="${@: -2:1}"
regen="${@: -1}"

timestemp=$(date +"%c")

export JAVA_OPTS="-Xmx512m"
export _JAVA_OPTIONS="-Xms1024m -Xmx64G -Xss512m"

export LOG_FILE=$SPATIAL_HOME/gen/results.log
export PID_LOG=$SPATIAL_HOME/gen/$app/pid.log

export BLUE='\033[0;34m'
export INFO='\033[1;33m'
export GREEN='\033[0;32m'
export RED='\033[0;31m'
export CYAN='\033[0;36m'
export NC='\033[0m'

passes=("GEN_PIR" "FIT_PIR" "GEN_CHISEL" "MAKE_VCS" "MAP_PIR" "RUN_SIMULATION")

declare -A logs
logs["GEN_PIR"]=$SPATIAL_HOME/gen/$app/gen_pir.log
logs["FIT_PIR"]=$PIR_HOME/out/$app/fit_pir.log
logs["GEN_CHISEL"]=$SPATIAL_HOME/gen/$app/gen_chisel.log
logs["MAKE_VCS"]=$SPATIAL_HOME/gen/$app/vcs.log
logs["MAP_PIR"]=$PIR_HOME/out/$app/map_pir.log
logs["RUN_SIMULATION"]=$SPATIAL_HOME/gen/$app/sim.log

declare -A scripts
scripts["GEN_PIR"]=$SPATIAL_HOME/apps/bin/gen_pir
scripts["FIT_PIR"]=$SPATIAL_HOME/apps/bin/fit_pir
scripts["GEN_CHISEL"]=$SPATIAL_HOME/apps/bin/gen_chisel
scripts["MAKE_VCS"]=$SPATIAL_HOME/apps/bin/make_vcs
scripts["MAP_PIR"]=$SPATIAL_HOME/apps/bin/map_pir
scripts["RUN_SIMULATION"]=$SPATIAL_HOME/apps/bin/run_sim

declare -A progress
for pass in ${passes[@]}; do
	progress[$pass]="NOTRUN"
done

passStatus() {
	pass=$1
	log=${logs[$pass]}
	if [ -e $log ]; then
		isDone=$(grep "$pass(DONE)" $log)
		if [[ $isDone != "" ]]; then
			isKilled=$(grep 'Killed\|KILLED' $log)
			isFailed=$(grep 'error\|Error\|ERROR\|No rule to make' $log)
      if [[ $pass == "RUN_SIMULATION" ]] && [[ $(grep "Design ran for" $log)=="" ]] ; then
        isFailed="Simulation not finished!"
      fi
			if [[ $isKilled != "" ]]; then
				progress[$pass]="KILLED"
			elif [[ $isFailed != "" ]]; then
				progress[$pass]="FAILED"
			else
				progress[$pass]="SUCCESS"
			fi
		else
			progress[$pass]="RUNNING"
		fi
	else
		progress[$pass]="NOTRUN"
	fi
}

function clean_log() {
	pass=$1
	log=${logs[$pass]}
	if [ -e $log ]; then rm $log; fi
}

